<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rutas</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <!-- Leaflet JavaScript -->
    <link rel="stylesheet" href="./assets/vendor/fonts/fontawesome.css" />
    <link rel="stylesheet" href="./assets/vendor/fonts/tabler-icons.css" />
    <link rel="stylesheet" href="./assets/vendor/fonts/flag-icons.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/spinkit/spinkit.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-fullscreen/dist/leaflet.fullscreen.css" />

    <link rel="stylesheet" href="./assets/vendor/css/rtl/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="./assets/vendor/css/rtl/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="./assets/css/demo.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/node-waves/node-waves.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/typeahead-js/typeahead.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/select2/select2.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/@form-validation/umd/styles/index.min.css" />
    <link rel="stylesheet" href="./assets/vendor/libs/bs-stepper/bs-stepper.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- jQuery UI -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.3/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js"></script>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/@turf/turf"></script>
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
    <style>
        #map {
            height: 100vh;
        }

        .card-container {
            position: absolute;
            top: 250px;
            right: 10px;

            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .card {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .marker {
            cursor: move;
            margin-bottom: 5px;
        }

        .marker img {
            width: 30px;
            height: auto;
        }

        #contenedor-checkboxes {
            position: absolute;
            top: 70px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            background-color: white;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 1000;
            font-size: 12px;
        }

        #toggle-controls {
            top: 20px;
            right: 30px;
            z-index: 1000;
            position: absolute;
            /*background-color: #4caf50;  Color de fondo */
            color: white;
            /* Color del texto */
            padding: 10px 20px;
            /* Espaciado interno */
            border: none;
            /* Sin borde */
            border-radius: 5px;
            /* Bordes redondeados */
            cursor: pointer;
            /* Cursor en forma de mano */
            margin-bottom: 10px;
            /* Margen inferior */
        }

        .toggle-controls-fecha {
            position: absolute;
            top: 20px;
            right: 580px;
            z-index: 1000;
            width: 13%;
        }

        .toggle-controls-fecha-2 {
            position: absolute;
            top: 20px;
            right: 320px;
            z-index: 1000;
            width: 13%;
        }


        #toggle-controls:hover {
            background-color: #45a049;
            /* Color al pasar el ratón por encima */
        }

        #toggle-containers {
            display: none;
            /* Oculta el botón por defecto */
        }

        #toggle-containers-1 {
            display: none;
            /* Oculta el botón por defecto */
        }

        #toggle-containers-2 {
            display: none;
            /* Oculta el botón por defecto */
        }

        #contenedor-filtro {
            position: absolute;
            top: 10px;
            right: 350px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            #toggle-controls {
                display: none;
                z-index: 1010;
                /* Asegura que el botón esté por encima de otros elementos */
                top: 10px;
                /* Ajusta según necesites */
                left: 50px;
                font-size: 10px;
            }

            #btnRutas {
                top: 50px;
                right: 10px;
                font-size: 10px;
            }

            #contenedor-checkboxes {
                display: flex;
                /* Habilita Flexbox para el contenedor */
                flex-direction: column;
                /* Alinea los elementos internos verticalmente */
                justify-content: center;
                /* Centra los elementos verticalmente */
                align-items: center;
                /* Centra los elementos horizontalmente */
                position: fixed;
                /* O absolute, dependiendo de tu necesidad */
                top: 50%;
                /* Posiciona el contenedor en el medio de la pantalla */
                left: 50%;
                /* Posiciona el contenedor en el medio de la pantalla */
                transform: translate(-50%, -50%);
                /* Ajusta precisamente el contenedor al centro */
                width: 80%;
                /* Ajusta el ancho del contenedor */
                max-width: 300px;
                /* Opcional: Limita el ancho máximo del contenedor */
                background-color: #fff;
                /* Fondo del contenedor para mejor visibilidad */
                padding: 20px;
                /* Espaciado interno para el contenedor */
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                /* Sombra suave para destacar el contenedor */
                z-index: 1000;
                /* Asegura que el contenedor esté por encima de otros elementos */
                overflow: auto;
                /* Permite desplazar dentro del contenedor si los elementos exceden el tamaño */
                border-radius: 10px;
                /* Bordes redondeados para el contenedor */
            }

            #leyenda {
                bottom: 50px;
            }

            #controls,
            #leyenda,
            #contenedor-checkboxes {
                display: none;
                /* Oculta los contenedores en pantallas pequeñas */
            }

            #toggle-containers {
                display: none;
                /* Muestra el botón en pantallas pequeñas */
                position: fixed;
                background-color: #02329b;
                /* Color de fondo */
                color: white;
                padding: 5px 10px;
                /* Espaciado interno */
                border: none;
                /* Sin borde */
                border-radius: 5px;
                /* O absolute, según tu preferencia de ubicación */
                z-index: 1010;
                /* Asegura que el botón esté por encima de otros elementos */
                top: 10px;
                /* Ajusta según necesites */
                right: 10px;
                /* Ajusta según necesites */
                /* Estilos adicionales para el botón (colores, padding, etc.) */
            }

            #toggle-containers-1 {
                display: block;
                /* Muestra el botón en pantallas pequeñas */
                position: fixed;
                background-color: #02329b;
                /* Color de fondo */
                color: white;
                padding: 5px 10px;
                /* Espaciado interno */
                border: none;
                /* Sin borde */
                border-radius: 5px;
                /* O absolute, según tu preferencia de ubicación */
                z-index: 1010;
                /* Asegura que el botón esté por encima de otros elementos */
                top: 10px;
                /* Ajusta según necesites */
                right: 10px;
                font-size: 10px;
                /* Ajusta según necesites */
                /* Estilos adicionales para el botón (colores, padding, etc.) */
            }

            #toggle-containers-2 {
                display: block;
                /* Muestra el botón en pantallas pequeñas */
                position: fixed;
                background-color: #02329b;
                /* Color de fondo */
                color: white;
                padding: 5px 10px;
                /* Espaciado interno */
                border: none;
                /* Sin borde */
                border-radius: 5px;
                /* O absolute, según tu preferencia de ubicación */
                z-index: 1010;
                /* Asegura que el botón esté por encima de otros elementos */
                top: 40px;
                /* Ajusta según necesites */
                right: 10px;
                font-size: 10px;
                /* Ajusta según necesites */
                /* Estilos adicionales para el botón (colores, padding, etc.) */
            }

        }

        #etiquetas {
            position: absolute;
            top: 200px;
            /* Ajusta la distancia desde la parte superior según sea necesario */
            left: 20px;
            /* Ajusta la distancia desde la izquierda según sea necesario */
            z-index: 1000;
        }

        input[type="number"] {
            width: 60px;
            /* Puedes ajustar el ancho según tus necesidades */
        }

        #exportarExcel {
            position: absolute;
            top: 320px;
            /* Ajusta la posición vertical según tus necesidades */
            right: 10px;
            /* Ajusta la posición horizontal según tus necesidades */
            padding: 10px 20px;
            /* Ajusta el espacio alrededor del texto del botón */
            background-color: #007bff;
            /* Color de fondo */
            color: #fff;
            /* Color del texto */
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #exportarExcel:hover {
            background-color: #0056b3;
            /* Color de fondo al pasar el mouse */
        }

        #eliminarUltimoPoligono {
            position: absolute;
            top: 390px;
            /* Ajusta la posición vertical según tus necesidades */
            right: 10px;
            /* Ajusta la posición horizontal según tus necesidades */
            padding: 10px 20px;
            /* Ajusta el espacio alrededor del texto del botón */
            background-color: #007bff;
            /* Color de fondo */
            color: #fff;
            /* Color del texto */
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #eliminarUltimoPoligono:hover {
            background-color: #0056b3;
            /* Color de fondo al pasar el mouse */
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="card-container">
        

        <div class="card" id="card1" onclick="addMarker(1)">
            <span class="marker"><img src="./policia.png"></span>
            <span class="quantity">Cantidad: <span id="qty1">10</span></span>
        </div>
        <div class="card" id="card2" onclick="addMarker(2)">
            <span class="marker"><img src="./moto.png"></span>
            <span class="quantity">Cantidad: <span id="qty2">10</span></span>
        </div>
        <div class="card" id="card3" onclick="addMarker(3)">
            <span class="marker"><img src="./sereno.png"></span>
            <span class="quantity">Cantidad: <span id="qty3">10</span></span>
        </div>

        <div>
            <label for="inputPatrullas">Patrullas:</label>
            <input type="number" id="inputPatrullas" min="0" value="10" onchange="updateQuantity('qty1', this.value)">
        </div>
        <div>
            <label for="inputMotos">Motos:</label>
            <input type="number" id="inputMotos" min="0" value="10" onchange="updateQuantity('qty2', this.value)">
        </div>
        <div>
            <label for="inputSerenos">Serenos:</label>
            <input type="number" id="inputSerenos" min="0" value="10" onchange="updateQuantity('qty3', this.value)">
        </div>
        <button id="exportarExcel">Exportar a Excel</button>
        <button id="eliminarUltimoPoligono">Eliminar Último Polígono</button>

        <button id="exportButton1" onclick="exportMarkersData()" style="display: none;">Exportar Datos de Marcadores</button>
        <button id="exportButton" style="display: none;">Exportar a Excel</button>
    </div>


    <div id="contenedor-checkboxes">
        <ul>
            <li>
                <label>
                    PROYECTO CAMARAS:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox10" />
                </label>
            </li>
            <li>
                <label>
                    CAMARAS VECINALES:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox6" />
                </label>
            </li>
            <li>
                <label>
                    CAMARAS ACTUALES:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox11" />
                </label>
            </li>
            <li>
                <label>
                    PUNTOS DE BASURA:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox7" />
                </label>
            </li>
            <li>
                <label>
                    PARADEROS DE TRANSPORTE:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox8" />
                </label>
            </li>
            <li>
                <label>
                    PANELES MONUMENTALES:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox9" />
                </label>
            </li>
            <li>
                <label>
                    CV-CAJA DE AGUA:
                    <input type="checkbox" id="mostrarMarcadoresCheckbox12" />
                </label>
            </li>
        </ul>
    </div>

    <div class="modal fade" id="addNewCCModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered1 modal-simple modal-add-new-cc modal-lg">
            <div class="modal-content p-3 p-md-5">
                <!-- <div id="controls"> -->
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                    <!--  FILTRO UNIDAD RUTAS SELECT --------------------------------------------------------------------------------- -->
                    <div class="text-center mb-4 mt-4">
                        <h3 class="mb-2">Filtrar Unidad de Transporte</h3>
                    </div>

                    <label>
                        <input type="checkbox" id="checkboxSeleccionarTodoRutas" onchange="seleccionarTodoRutas()">
                        Seleccionar Todo
                    </label>

                    <form class="row g-3" onsubmit="return false">
                        <div class="col-12 col-md-12">
                            <label for="groupUnidad">Unidad: </label>
                            <select id="groupUnidad" name="groupUnidad " class=" form-control" onchange="mostrarRutas()"
                                multiple>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="DateInicio">Fecha inicio: </label>
                            <input type="date" id="startDateInputRutas" name="trip-start" class="form-control"
                                value="" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="DateFin">Fecha Final: </label>
                            <input type="date" id="endDateInputRutas" name="trip-start" class="form-control" value=""
                                onchange="filtrarFechasRutas()" />
                            <!-- <input type="date" id="DateFinal" name="trip-start" class="form-control" value=""/> -->
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="DateInicio">Hora inicio: </label>
                            <input type="time" id="HoraInicioRutas" name="trip-start" class="form-control" value=""
                                step="1" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="DateFin">Hora Final: </label>
                            <input type="time" id="HoraFinalRutas" name="trip-start" class="form-control" value=""
                                step="1" onchange="filtrarFechasRutas()" />
                            <!-- <input type="date" id="DateFinal" name="trip-start" class="form-control" value=""/> -->
                        </div>

                    </form>

                </div>
                <button type="reset" class="btn btn-label-secondary btn-reset" data-bs-dismiss="modal"
                    aria-label="Close">
                    Volver
                </button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addNewIncModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered1 modal-simple modal-add-new-cc modal-lg">
            <div class="modal-content p-3 p-md-5">
                <!-- <div id="controls"> -->
                <div class="modal-body">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                    <!--  FILTRO UNIDAD RUTAS SELECT --------------------------------------------------------------------------------- -->
                    <div class="text-center mb-4 mt-4">
                        <h3 class="mb-2">Filtrar Incidencias</h3>
                    </div>

                    <label>
                        <input type="checkbox" id="checkboxSeleccionarTodo" onchange="seleccionarTodo()">
                        Seleccionar Todo
                    </label>

                    <form class="row g-3" onsubmit="return false">
                        <div class="col-12 col-md-12">
                            <label for="group1">Jurisdiccion: </label>
                            <select id="group1" name="group1 " class=" form-control" onchange="populateGroup2()"
                                multiple>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="group2">Agrupacion: </label>
                            <select id="group2" name="group2 " class=" form-control" onchange="populateGroup3()"
                                multiple>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="group3">Clasificacion: </label>
                            <select id="group3" name="group2 " class=" form-control" onchange="populateGroup4()"
                                multiple>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="group4">Tipo de Caso: </label>
                            <select id="group4" name="group2 " class=" form-control" onchange="getTipoCaso()" multiple>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="subTipoCaso">Sub Tipo de Caso: </label>
                            <select id="subTipoCaso" name="group2 " class=" form-control" onchange="getSubTipoCaso()"
                                multiple>
                            </select>
                        </div>
                        <!-- <div class="col-12 col-md-6">
                            <label for="DateInicio">Fecha inicio: </label>
                            <input type="date" id="DateInicio" name="trip-start" class="form-control" value="" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="DateFin">Fecha Final: </label>
                            <input type="date" id="DateFinal" name="trip-start" class="form-control" value=""
                                onchange="getFechaRango()" />
                        </div> -->

                        <div class="col-12 col-md-6">
                            <label for="DateInicio">Hora inicio: </label>
                            <input type="time" id="HoraInicio" name="trip-start" class="form-control" value=""
                                step="1" />
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="DateFin">Hora Final: </label>
                            <input type="time" id="HoraFinal" name="trip-start" class="form-control" value="" step="1"
                                onchange="getHoraRango()" />
                            <!-- <input type="date" id="DateFinal" name="trip-start" class="form-control" value=""/> -->
                        </div>

                    </form>

                </div>
                <button type="reset" class="btn btn-label-secondary btn-reset" data-bs-dismiss="modal"
                    aria-label="Close">
                    Volver
                </button>
            </div>
        </div>
    </div>

    <button id="toggle-containers">Filtro de Incidencias</button>
    <button id="toggle-containers-1">Filtro de Camaras</button>
    <button id="toggle-containers-2">Mostrar/Ocultar Leyenda</button>


    <button id="toggle-controls" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNewIncModal">Mostrar
        Incidencias</button>
    
    <input type="date" id="DateInicio" name="trip-start" class="form-control toggle-controls-fecha" value=""
        onchange="getFechaRango()" />

    <input type="date" id="DateFinal" name="trip-start" class="form-control toggle-controls-fecha-2" value=""
        onchange="getFechaRango()" />

    <!-- <button id="btnRutas" type="button" class="btn btn-primary"
        style="right: 10px; z-index: 1020; position: absolute; margin-top: 20px;" data-bs-toggle="modal"
        data-bs-target="#addNewCCModal">
        <i class="fas fa-search me-2"> </i>Mostrar Rutas
    </button> -->
    
    <script>
        // Selecciona el botón por su identificador y agrega un evento de click

        // function updateQuantity(elementId, newValue) {
        //     document.getElementById(elementId).textContent = newValue;
        // }
        // document.getElementById('toggle-containers').addEventListener('click', function () {
        //     var containers = document.querySelectorAll('#controls');
        //     containers.forEach(function (container) {
        //         if (container.style.display === 'block') {
        //             container.style.display = 'none';
        //         } else {
        //             container.style.display = 'block';
        //         }
        //     });
        // });
        function updateQuantity(id, value) {
        document.getElementById(id).textContent = value;
    }
        document.getElementById('toggle-containers-1').addEventListener('click', function () {
            var containers = document.querySelectorAll('#contenedor-checkboxes');
            containers.forEach(function (container) {
                if (container.style.display === 'block') {
                    container.style.display = 'none';
                } else {
                    container.style.display = 'block';
                }
            });
        });

        document.getElementById('toggle-containers-2').addEventListener('click', function () {
            var containers = document.querySelectorAll('#leyenda');
            containers.forEach(function (container) {
                if (container.style.display === 'block') {
                    container.style.display = 'none';
                } else {
                    container.style.display = 'block';
                }
            });
        });
        // Initialize the map
        var map = L.map('map').setView([-12.004169547854145, -77.00349050726693], 13);
        var markers1 = [];
        const arrayHeat = [];
        const url = "./incidencias_18_03_24.json";
        const urlRutas = './data_rutas.json';
        let dataJSON_Unidades;
        let dataJSON;
        let heatLayer;
        let circleMarkersLayer;
        let markers;
        var colors = ['red', 'blue', 'green', 'orange', 'purple']; // Colores para las rutas

        var routeCounter = 1; // Contador para asignar nombres a las rutas

        let polygon;
        var csvPath = "/Zarate.csv";
        var csvFilePath1 = "/10 de Octubre.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var csvFilePath2 = "/Bayovar.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var csvFilePath3 = "/Caja de Agua.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var csvFilePath4 = "/Canto Rey.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var csvFilePath5 = "/La Huayrona.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var csvFilePath6 = "/Mariscal Caceres.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var csvFilePath7 = "/Santa Elizabeth.csv"; // Reemplaza 'tu_archivo.csv' con la ruta de tu archivo CSV
        var polygonColor = "black"; // Color del polígono
        var polygonColor2 = "blue"; // Color del polígono
        var polygonColor3 = "green"; // Color del polígono
        var polygonColor4 = "purple"; // Color del polígono
        var polygonColor5 = "orange"; // Color del polígono
        var polygonColor6 = "red"; // Color del polígono
        var polygonColor7 = "gray"; // Color del polígono
        var polygonColor8 = "brown"; // Color del polígono

        // Add the map layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        async function cargarCSVyCrearPoligono(url) {
            const response = await fetch(url);
            const data = await response.text();
            const lines = data.split('\n').slice(1); // Elimina el encabezado
            let coords = lines.map(line => {
                const [lat, lng] = line.split(';').map(Number);
                return [lng, lat]; // Turf.js utiliza [longitud, latitud]
            });

            // Asegúrate de que el polígono esté cerrado
            if (coords.length > 0 && (coords[0][0] !== coords[coords.length - 1][0] || coords[0][1] !== coords[coords.length - 1][1])) {
                coords.push(coords[0]); // Añade la primera coordenada al final para cerrar el polígono
            }

            // Crea un polígono GeoJSON
            return turf.polygon([coords]);
        }

        // Function to create markers
        // Función para exportar los puntos finales a un archivo Excel

        // Capa para almacenar las polilíneas dibujadas
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        var routes = []; // Almacena las rutas dibujadas

        // Configurar el control de dibujo
        var drawControl = new L.Control.Draw({
            draw: {
                polyline: true,
                polygon: false,
                rectangle: false,
                circle: false,
                marker: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems
            }
        });


        // map.addControl(drawControl);


        // Manejar evento de finalización de dibujo
        map.on('draw:created', function (e) {
            var type = e.layerType,
                layer = e.layer;

            if (type === 'polyline') {
                // Asignar un color único a cada ruta
                var color = colors[routes.length % colors.length];
                layer.setStyle({ color: color });

                // Asignar nombre a la ruta
                var routeName = 'Patrulla' + routeCounter++;

                // Agregar la polilínea a la capa del mapa y al arreglo de rutas
                drawnItems.addLayer(layer);
                routes.push({ name: routeName, polyline: layer });
            }
        });

        // Función para exportar a Excel
        document.getElementById('exportButton').addEventListener('click', function () {
            var excelContent = "Ruta,Latitud,Longitud\n"; // Encabezado del archivo Excel

            routes.forEach(function (route) {
                var routeName = route.name;
                var latLngs = route.polyline.getLatLngs();
                var coordenadas = latLngs.map(function (coord) {
                    return coord.lat + ',' + coord.lng;
                }).join('/');

                // Agregar una fila con el nombre de la ruta y un enlace de Google Maps a la ruta completa
                var enlaceGoogleMaps = 'https://www.google.com/maps/dir/' + coordenadas;
                excelContent += routeName + ",," + enlaceGoogleMaps + "\n"; // No agregamos latitud y longitud en esta columna
            });

            var encodedUri = encodeURI(excelContent);
            var link = document.createElement("a");
            link.setAttribute("href", 'data:text/csv;charset=utf-8,' + encodeURIComponent(excelContent));
            link.setAttribute("download", "rutas.csv");
            document.body.appendChild(link);
            link.click(); // Simula un clic en el enlace para iniciar la descarga
        });

        function createMarker(latlng, cardId, iconUrl) {
            var markerHtml = '<img src="' + iconUrl + '" class="drag-marker" style="width:40px;height:auto;">';
            var marker1 = L.marker(latlng, { draggable: true, icon: L.divIcon({ html: markerHtml, className: 'custom-div-icon' }) }).addTo(map);
            marker1.cardId = cardId;
            markers1.push(marker1);
            marker1.on('dragend', function (event) {
                console.log('Latitud:', event.target._latlng.lat, 'Longitud:', event.target._latlng.lng);
            });
            marker1.on('contextmenu', function (e) {
                e.originalEvent.preventDefault();
                removeMarker(marker1);
            });
        }

        // Function to remove marker and increase quantity
        function removeMarker(marker1) {
            var cardId = marker1.cardId;
            var quantityElement = $('#qty' + cardId);
            var currentQty = parseInt(quantityElement.text());
            quantityElement.text(currentQty + 1);
            map.removeLayer(marker1);
            markers1 = markers1.filter(function (m) {
                return m !== marker1;
            });
        }

        // Function to add marker when card is clicked
        var markersData = []; // Array para almacenar la información de los marcadores

        // Función para agregar un marcador al mapa y al registro de marcadores
        // function addMarker(cardId) {
        //     var quantityElement = $('#qty' + cardId);
        //     var currentQty = parseInt(quantityElement.text());
        //     if (currentQty > 0) {
        //         // Reducir la cantidad disponible
        //         quantityElement.text(currentQty - 1);
        //         // Definir la URL del icono según el tipo de marcador
        //         var iconUrl = '';
        //         if (cardId === 1) {
        //             iconUrl = './policia.png';
        //         } else if (cardId === 2) {
        //             iconUrl = './moto.png';
        //         } else if (cardId === 3) {
        //             iconUrl = './sereno.png'
        //         }

        //         // Obtener la posición del marcador
        //         var latLng = map.getCenter();

        //         // Crear un nuevo marcador en la posición obtenida
        //         var marker = createMarker(latLng, cardId, iconUrl);

        //         // Agregar la información del marcador al registro
        //         markersData.push({
        //             latitud: latLng.lat,
        //             longitud: latLng.lng,
        //             tipo: cardId === 1 ? 'Patrulla' : cardId === 2 ? 'Moto' : 'Sereno'
        //         });
        //     }
        // }

        // Función para exportar los datos de los marcadores a un archivo CSV
        function exportMarkersData() {
        var data = [];
        rutas.forEach((ruta, index) => {
            ruta.marcadores.forEach(punto => {
                data.push({
                    Ruta: index + 1,
                    'Tipo de Marcador': punto.tipo,
                    Latitud: punto.lat,
                    Longitud: punto.lng
                });
            });
        });

        // Convertir los datos a formato JSON
        var jsonData = JSON.stringify(data);

        // Crear un Blob para guardar los datos JSON
        var blob = new Blob([jsonData], { type: 'application/json' });

        // Crear un enlace y hacer clic en él para descargar el archivo JSON
        var a = document.createElement('a');
        document.body.appendChild(a);
        a.href = window.URL.createObjectURL(blob);
        a.download = 'datos_marcadores.json';
        a.click();
    }

        // Integrating code for dragging and dropping icons
        // $('#map').droppable({
        //     drop: function (event, ui) {
        //         var cardId = ui.draggable.data('cardId');
        //         // Get the coordinates of the point where the icon was dropped
        //         var latLng = map.mouseEventToLatLng(event);
        //         // Define the URL of the icon based on the type of marker
        //         var iconUrl = '';
        //         if (cardId === 1) {
        //             iconUrl = './policia.png';
        //         } else if (cardId === 2) {
        //             iconUrl = './moto.png';
        //         }
        //         // Create a new marker at the obtained coordinates with the corresponding icon
        //         createMarker(latLng, cardId, iconUrl);
        //     }
        // });

        function showPolygonFromCSV(csvFilePath, color, popupMessage, name) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var csvData = xhr.responseText;
                        var csvRows = csvData.split("\n");

                        var latlngs = [];

                        for (var i = 0; i < csvRows.length; i++) {
                            var rowData = csvRows[i].split(","); // Cambiar '\t' si el delimitador es diferente

                            // Verificar si hay al menos dos elementos en la fila
                            if (rowData.length >= 2) {
                                // Convertir las coordenadas a números
                                var latitude = parseFloat(rowData[0].trim());
                                var longitude = parseFloat(rowData[1].trim());

                                // Verificar si los datos son válidos
                                if (!isNaN(latitude) && !isNaN(longitude)) {
                                    latlngs.push([latitude, longitude]);
                                }
                            }
                        }

                        // Mostrar el polígono en el mapa con un popup estático
                        var polygon = L.polygon(latlngs, { color: color, fillOpacity: 0.05 }).addTo(map);
                        // globalPolygons.push(latlngs);
                        //map.fitBounds(polygon.getBounds());

                        // Agregar evento click al polígono
                        polygon.on("click", function (e) {
                            var lat = e.latlng.lat;
                            var lng = e.latlng.lng;

                            var nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;

                            fetch(nominatimUrl)
                                .then((response) => response.json())
                                .then((data) => {
                                    var address = data.display_name;
                                    var addressDetails = data.address;

                                    var cuadra = addressDetails.road;
                                    //var jurisdiccion = addressDetails.city;
                                    var jurisdiccion = popupMessage;
                                    var urbanizacion = name;

                                    // Puedes realizar acciones adicionales aquí, como abrir un modal
                                    openModal(
                                        lat,
                                        lng,
                                        address,
                                        addressDetails,
                                        cuadra,
                                        jurisdiccion,
                                        urbanizacion
                                    );
                                    console.log(addressDetails);
                                })
                                .catch((error) => {
                                    console.error("Error al obtener la dirección:", error);
                                });
                        });
                    } else {
                        console.error("Error al cargar el archivo CSV: " + csvFilePath);
                    }
                }
            };

            xhr.open("GET", csvFilePath, true);
            xhr.send();
        }

        document.addEventListener("DOMContentLoaded", function () {
            if (polygon) {
                map.removeLayer(polygon);
            }
            showPolygonFromCSV(csvPath, polygonColor, 2, "Zarate");
            showPolygonFromCSV(csvFilePath1, polygonColor2, 8, "10 de Octubre");
            showPolygonFromCSV(csvFilePath2, polygonColor3, 6, "Bayovar");
            showPolygonFromCSV(csvFilePath3, polygonColor4, 1, "Caja de Agua");
            showPolygonFromCSV(csvFilePath4, polygonColor5, 4, "Canto Rey");
            showPolygonFromCSV(csvFilePath5, polygonColor6, 3, "La Huayrona");
            showPolygonFromCSV(csvFilePath6, polygonColor7, 7, "Mariscal Caceres");
            showPolygonFromCSV(csvFilePath7, polygonColor8, 5, "Santa Elizabeth");
        });

        function convertirAHorasSegundos(hora) {
            const partesHora = hora.split(":");
            const horas = parseInt(partesHora[0]);
            const minutos = parseInt(partesHora[1]);
            const segundos = partesHora.length > 2 ? parseInt(partesHora[2]) : 0; // Si hay segundos en la hora, convertirlos también

            return horas * 3600 + minutos * 60 + segundos;
        }

        function getHoraRango() {
            clearMap();
            const csvUrl = './areaasjl.csv';
            cargarCSVyCrearPoligono(csvUrl).then(geoJsonPolygon => {
                const group1Select = document.getElementById("group1");
                const group2Select = document.getElementById("group2");
                const group3Select = document.getElementById("group3");
                const group4Select = document.getElementById("group4");
                const subTipoCasoSelect = document.getElementById("subTipoCaso");
                const fechaSelect = document.getElementById("DateInicio"); // Agrega el elemento de fecha
                const fechaSelectFin = document.getElementById("DateFinal"); // Agrega el elemento de fecha
                const horaSelect = document.getElementById("HoraInicio"); // Agrega el elemento de fecha
                const horaSelectFin = document.getElementById("HoraFinal"); // Agrega el elemento de fecha
                // const horaSelect = document.getElementById("hora");
                datosFiltrados = [];
                const markers = [];
                const clickHandler = (lat, lon, content) => {
                    const marker = L.marker([lat, lon]);
                    marker.bindPopup(content).openPopup();
                    markers.push(marker);
                };
                // Customize this logic based on your data
                const selectedGroup1Values = Array.from(group1Select.selectedOptions).map(option => option.value);
                const selectedGroup2Values = Array.from(group2Select.selectedOptions).map(option => option.value);
                const selectedGroup3Values = Array.from(group3Select.selectedOptions).map(option => option.value);
                const selectedGroup4Values = Array.from(group4Select.selectedOptions).map(option => option.value);
                const selectedTipoCasoValues = Array.from(subTipoCasoSelect.selectedOptions).map(option => option.value);

                const selectedFechaInicio = fechaSelect.value;
                const selectedFechaFin = fechaSelectFin.value; // Obtén la fecha seleccionada
                const selectedHoraInicio = horaSelect.value; // Obtén la fecha seleccionada
                const selectedHoraFin = horaSelectFin.value; // Obtén la fecha seleccionada
                // const selectedHora = horaSelect.value;
                circleMarkersLayer = new L.LayerGroup();
                map.addLayer(circleMarkersLayer);
                console.log(selectedHoraInicio)

                dataJSON.forEach(element => {
                    // Filter based on selected values
                    if (
                        (selectedGroup1Values.length === 0 || selectedGroup1Values.includes(element["Comisaria"])) &&
                        (selectedGroup2Values.length === 0 || selectedGroup2Values.includes(element["Agrupacion"])) &&
                        (selectedGroup3Values.length === 0 || selectedGroup3Values.includes(element["Nueva Clasificacion"])) &&
                        (selectedGroup4Values.length === 0 || selectedGroup4Values.includes(element["Tipo de Caso"])) &&
                        // (selectedTipoCasoValues.length === 0 || selectedTipoCasoValues.includes(element["Sub Tipo de Caso"]))&&
                        filtrarPorRangoDeFechas(element, selectedFechaInicio, selectedFechaFin) &&
                        filtrarPorRangoDeHoras(element, selectedHoraInicio, selectedHoraFin)

                    ) {
                        var point = turf.point([element.Longitud, element.Latitud]);
                        if (turf.booleanPointInPolygon(point, geoJsonPolygon)) {
                            let weight = 1; // Ponderación predeterminada
                            if (selectedGroup3Values.includes("Homicidio")) {
                                weight = 100; // Duplicar el peso si el tipo de caso es homicidio
                            }
                            const obj = [element.Latitud, element.Longitud, weight];
                            arrayHeat.push(obj);

                            const content = `<b>Comisaria:</b> ${element["Comisaria"]}<br><b>Agrupacion:</b> ${element["Agrupacion"]}<br><b>Clasificacion:</b> ${element["Nueva Clasificacion"]}<br><b>Tipo de caso:</b> ${element["Tipo de Caso"]}<br><b>Sub Tipo de Caso:</b> ${element["Sub Tipo de Caso"]}<br>
                    <b>Fecha:</b> ${element["Fecha"]}<br><b>Hora:</b> ${element["Hora_Minuto"]}<br>`;

                            // Attach click event to each heat point
                            const circleMarker = L.circleMarker([element.Latitud, element.Longitud], { radius: 25, color: 'red' })
                                .bindPopup(content)
                                .addTo(circleMarkersLayer)
                                .on('click', function () {
                                    console.log(element.Latitud);
                                });

                        }
                        // Personalizar tu marcador aquí
                        const myIcon = L.icon({
                            iconUrl: 'my-icon.png',
                            iconSize: [38, 50],
                            iconAnchor: [30, 94],
                            popupAnchor: [-3, -76],
                            shadowUrl: 'my-icon-shadow.png',
                            shadowSize: [68, 95],
                            shadowAnchor: [22, 94]
                        });

                        const marker = L.marker([element.Latitud, element.Longitud]) //.addTo(markers);
                        marker.bindPopup(
                            `<b>Comisaria:</b> ${element["Comisaria"]}<br><b>Prioridad:</b> ${element["Prioridad"]}<br><b>Tipo de caso:</b> ${element["Tipo de caso"]}<br><b>Sub Tipo de Caso:</b> ${element["Sub Tipo de Caso"]}<br><b>Latitud: </b>${element.Latitud}<br><b>Longitud: </b>${element.Longitud}`
                        );
                    }
                });

                const gradient = {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.8: 'lime',
                    1.0: 'red'
                };

                //heatLayer = L.heatLayer(arrayHeat, { radius: 25 }).addTo(map);
                heatLayer = L.heatLayer(arrayHeat, { radius: 25, gradient: gradient }).addTo(map);

                markers.forEach(marker => {
                    marker.addTo(map);
                });

            });
            console.log(arrayHeat);
        }

        function getFechaRango() {
            clearMap();
            const csvUrl = './areaasjl.csv';
            cargarCSVyCrearPoligono(csvUrl).then(geoJsonPolygon => {
                const group1Select = document.getElementById("group1");
                const group2Select = document.getElementById("group2");
                const group3Select = document.getElementById("group3");
                const group4Select = document.getElementById("group4");
                const subTipoCasoSelect = document.getElementById("subTipoCaso");
                const fechaSelect = document.getElementById("DateInicio"); // Agrega el elemento de fecha
                const fechaSelectFin = document.getElementById("DateFinal"); // Agrega el elemento de fecha
                // const horaSelect = document.getElementById("hora");
                datosFiltrados = [];
                const markers = [];
                const clickHandler = (lat, lon, content) => {
                    const marker = L.marker([lat, lon]);
                    marker.bindPopup(content).openPopup();
                    markers.push(marker);
                };
                // Customize this logic based on your data
                const selectedGroup1Values = Array.from(group1Select.selectedOptions).map(option => option.value);
                const selectedGroup2Values = Array.from(group2Select.selectedOptions).map(option => option.value);
                const selectedGroup3Values = Array.from(group3Select.selectedOptions).map(option => option.value);
                const selectedGroup4Values = Array.from(group4Select.selectedOptions).map(option => option.value);
                const selectedTipoCasoValues = Array.from(subTipoCasoSelect.selectedOptions).map(option => option.value);

                const selectedFechaInicio = fechaSelect.value;
                const selectedFechaFin = fechaSelectFin.value; // Obtén la fecha seleccionada
                // const selectedHora = horaSelect.value;
                circleMarkersLayer = new L.LayerGroup();
                map.addLayer(circleMarkersLayer);
                console.log(selectedFechaInicio)

                dataJSON.forEach(element => {
                    // Filter based on selected values
                    if (
                        (selectedGroup1Values.length === 0 || selectedGroup1Values.includes(element["Comisaria"])) &&
                        (selectedGroup2Values.length === 0 || selectedGroup2Values.includes(element["Agrupacion"])) &&
                        (selectedGroup3Values.length === 0 || selectedGroup3Values.includes(element["Nueva Clasificacion"])) &&
                        (selectedGroup4Values.length === 0 || selectedGroup4Values.includes(element["Tipo de Caso"])) &&
                        // (selectedTipoCasoValues.length === 0 || selectedTipoCasoValues.includes(element["Sub Tipo de Caso"]))&&
                        filtrarPorRangoDeFechas(element, selectedFechaInicio, selectedFechaFin)
                    ) {
                        var point = turf.point([element.Longitud, element.Latitud]);
                        if (turf.booleanPointInPolygon(point, geoJsonPolygon)) {
                            let weight = 1; // Ponderación predeterminada
                            if (selectedGroup3Values.includes("Homicidio")) {
                                weight = 100; // Duplicar el peso si el tipo de caso es homicidio
                            }
                            const obj = [element.Latitud, element.Longitud, weight];
                            arrayHeat.push(obj);

                            const content = `<b>Comisaria:</b> ${element["Comisaria"]}<br><b>Agrupacion:</b> ${element["Agrupacion"]}<br><b>Clasificacion:</b> ${element["Nueva Clasificacion"]}<br><b>Tipo de caso:</b> ${element["Tipo de Caso"]}<br><b>Sub Tipo de Caso:</b> ${element["Sub Tipo de Caso"]}<br>
                    <b>Fecha:</b> ${element["Fecha"]}<br><b>Hora:</b> ${element["Hora_Minuto"]}<br>`;

                            // Attach click event to each heat point
                            const circleMarker = L.circleMarker([element.Latitud, element.Longitud], { radius: 25, color: 'red' })
                                .bindPopup(content)
                                .addTo(circleMarkersLayer)
                                .on('click', function () {
                                    console.log(element.Latitud);
                                });
                        }

                        // Personalizar tu marcador aquí
                        const myIcon = L.icon({
                            iconUrl: 'my-icon.png',
                            iconSize: [38, 50],
                            iconAnchor: [30, 94],
                            popupAnchor: [-3, -76],
                            shadowUrl: 'my-icon-shadow.png',
                            shadowSize: [68, 95],
                            shadowAnchor: [22, 94]
                        });

                        const marker = L.marker([element.Latitud, element.Longitud]) //.addTo(markers);
                        marker.bindPopup(
                            `<b>Comisaria:</b> ${element["Comisaria"]}<br><b>Prioridad:</b> ${element["Prioridad"]}<br><b>Tipo de caso:</b> ${element["Tipo de caso"]}<br><b>Sub Tipo de Caso:</b> ${element["Sub Tipo de Caso"]}<br><b>Latitud: </b>${element.Latitud}<br><b>Longitud: </b>${element.Longitud}`
                        );
                    }
                });

                const gradient = {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.8: 'lime',
                    1.0: 'red'
                };

                //heatLayer = L.heatLayer(arrayHeat, { radius: 25 }).addTo(map);
                heatLayer = L.heatLayer(arrayHeat, { radius: 25, gradient: gradient }).addTo(map);

                markers.forEach(marker => {
                    marker.addTo(map);
                });

            });
            //console.log(arrayHeat);
        }

        function getSubTipoCaso() {
            clearMap();
            const csvUrl = './areaasjl.csv';
            cargarCSVyCrearPoligono(csvUrl).then(geoJsonPolygon => {
                const group1Select = document.getElementById("group1");
                const group2Select = document.getElementById("group2");
                const group3Select = document.getElementById("group3");
                const group4Select = document.getElementById("group4");
                const subTipoCasoSelect = document.getElementById("subTipoCaso");

                // Customize this logic based on your data
                const selectedGroup1Values = Array.from(
                    group1Select.selectedOptions
                ).map((option) => option.value);
                const selectedGroup2Values = Array.from(
                    group2Select.selectedOptions
                ).map((option) => option.value);
                const selectedGroup3Values = Array.from(
                    group3Select.selectedOptions
                ).map((option) => option.value);
                const selectedGroup4Values = Array.from(
                    group4Select.selectedOptions
                ).map((option) => option.value);
                const selectedTipoCasoValues = Array.from(
                    subTipoCasoSelect.selectedOptions
                ).map((option) => option.value);

                dataJSON.forEach((element) => {
                    // Filter based on selected values
                    if (
                        (selectedGroup1Values.length === 0 ||
                            selectedGroup1Values.includes(element["Comisaria"])) &&
                        (selectedGroup2Values.length === 0 ||
                            selectedGroup2Values.includes(element["Agrupacion"])) &&
                        (selectedGroup3Values.length === 0 ||
                            selectedGroup3Values.includes(element["Nueva Clasificacion"])) &&
                        (selectedGroup4Values.length === 0 ||
                            selectedGroup4Values.includes(element["Tipo de Caso"])) &&
                        (selectedTipoCasoValues.length === 0 ||
                            selectedTipoCasoValues.includes(element["Sub Tipo de Caso"]))
                    ) {
                        var point = turf.point([element.Longitud, element.Latitud]);
                        if (turf.booleanPointInPolygon(point, geoJsonPolygon)) {
                            let weight = 1; // Ponderación predeterminada
                            if (selectedGroup3Values.includes("Homicidio")) {
                                weight = 100; // Duplicar el peso si el tipo de caso es homicidio
                            }
                            const obj = [element.Latitud, element.Longitud, weight];
                            arrayHeat.push(obj);
                        }


                        // Personalizar tu marcador aquí
                        const myIcon = L.icon({
                            iconUrl: "my-icon.png",
                            iconSize: [38, 50],
                            iconAnchor: [30, 94],
                            popupAnchor: [-3, -76],
                            shadowUrl: "my-icon-shadow.png",
                            shadowSize: [68, 95],
                            shadowAnchor: [22, 94],
                        });

                        const marker = L.marker([element.Latitud, element.Longitud]); //.addTo(markers);
                        marker.bindPopup(
                            `<b>Comisaria:</b> ${element["Comisaria"]}<br><b>Prioridad:</b> ${element["Prioridad"]}<br><b>Tipo de caso:</b> ${element["Tipo de Caso"]}<br><b>Sub Tipo de Caso:</b> ${element["Sub Tipo de Caso"]}<br><b>Latitud: </b>${element.Latitud}<br><b>Longitud: </b>${element.Longitud}`
                        );
                    }
                });
                const gradient = {
                    0.4: 'blue',
                    0.6: 'cyan',
                    0.8: 'lime',
                    1.0: 'red'
                };


                //heatLayer = L.heatLayer(arrayHeat, { radius: 25 }).addTo(map);
                heatLayer = L.heatLayer(arrayHeat, { radius: 25, gradient: gradient }).addTo(map);

            });

        }

        function getTipoCaso() {
            clearMap();
            const group1Select = document.getElementById("group1");
            const group2Select = document.getElementById("group2");
            const group3Select = document.getElementById("group3");
            const group4Select = document.getElementById("group4");
            const subTipoCasoSelect = document.getElementById("subTipoCaso");

            // Customize this logic based on your data
            const selectedGroup1Values = Array.from(
                group1Select.selectedOptions
            ).map((option) => option.value);
            const selectedGroup2Values = Array.from(
                group2Select.selectedOptions
            ).map((option) => option.value);
            const selectedGroup3Values = Array.from(
                group3Select.selectedOptions
            ).map((option) => option.value);
            const selectedGroup4Values = Array.from(
                group4Select.selectedOptions
            ).map((option) => option.value);
            subTipoCasoSelect.innerHTML = "";

            if (
                selectedGroup1Values.length !== 0 &&
                selectedGroup2Values.length !== 0 &&
                selectedGroup3Values.length !== 0 &&
                selectedGroup4Values.length !== 0
            ) {
                // Customize this logic based on your data
                const subTipoCasos = dataJSON
                    .filter(
                        (element) =>
                            selectedGroup1Values.includes(element["Comisaria"]) &&
                            selectedGroup2Values.includes(element["Agrupacion"]) &&
                            selectedGroup3Values.includes(element["Nueva Clasificacion"]) &&
                            selectedGroup4Values.includes(element["Tipo de Caso"])
                    )
                    .map((element) => element["Sub Tipo de Caso"]);

                const uniqueSubTipoCasos = [...new Set(subTipoCasos)];

                uniqueSubTipoCasos.forEach((subTipoCaso) => {
                    const option = document.createElement("option");
                    option.value = subTipoCaso;
                    option.text = subTipoCaso;
                    subTipoCasoSelect.appendChild(option);
                });
            }

            getSubTipoCaso();
        }

        function populateGroup2() {
            clearMap();
            const group1Select = document.getElementById("group1");
            const group2Select = document.getElementById("group2");
            const group3Select = document.getElementById("group3");

            group2Select.innerHTML = "";
            group3Select.innerHTML = "";

            const selectedGroup1Values = Array.from(
                group1Select.selectedOptions
            ).map((option) => option.value);

            if (selectedGroup1Values.length !== 0) {
                // Customize this logic based on your data
                const subTypes = dataJSON
                    .filter((element) =>
                        selectedGroup1Values.includes(element["Comisaria"])
                    )
                    .map((element) => element["Agrupacion"]);

                const uniqueSubTypes = [...new Set(subTypes)];

                uniqueSubTypes.forEach((subType) => {
                    const option = document.createElement("option");
                    option.value = subType;
                    option.text = subType;
                    group2Select.appendChild(option);
                });
            }

            getTipoCaso(); // Llamar a getTipoCaso() después de poblar group2
        }

        function filtrarPorRangoDeFechas(element, fechaInicio, fechaFin) {
            const fechaElemento = new Date(element.Fecha);
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            return fechaElemento >= inicio && fechaElemento <= fin;
        }

        function filtrarPorRangoDeHoras(element, horaInicio, horaFin) {
            // Convertir la hora a segundos desde medianoche
            const segundosDesdeMedianoche = (hora) => {
                const [horas, minutos, segundos] = hora.split(":").map(Number);
                return horas * 3600 + minutos * 60 + segundos;
            };

            const segundosElemento = segundosDesdeMedianoche(element["Hora_Minuto"]);
            const segundosInicio = segundosDesdeMedianoche(horaInicio);
            const segundosFin = segundosDesdeMedianoche(horaFin);

            // Comparar si la hora del elemento está dentro del rango
            return segundosElemento >= segundosInicio && segundosElemento <= segundosFin;
        }

        function populateGroup3() {
            clearMap();
            const group1Select = document.getElementById("group1");
            const group2Select = document.getElementById("group2");
            const group3Select = document.getElementById("group3");

            group3Select.innerHTML = "";

            const selectedGroup1Values = Array.from(
                group1Select.selectedOptions
            ).map((option) => option.value);
            const selectedGroup2Values = Array.from(
                group2Select.selectedOptions
            ).map((option) => option.value);

            if (
                selectedGroup1Values.length !== 0 &&
                selectedGroup2Values.length !== 0
            ) {
                // Customize this logic based on your data
                const subTypes = dataJSON
                    .filter(
                        (element) =>
                            selectedGroup1Values.includes(element["Comisaria"]) &&
                            selectedGroup2Values.includes(element["Agrupacion"])
                    )
                    .map((element) => element["Nueva Clasificacion"]);

                const uniqueSubTypes = [...new Set(subTypes)];

                uniqueSubTypes.forEach((subType) => {
                    const option = document.createElement("option");
                    option.value = subType;
                    option.text = subType;
                    group3Select.appendChild(option);
                });
            }
            getTipoCaso(); // Llamar a getTipoCaso() después de poblar group3
        }

        function populateGroup4() {
            clearMap();
            const group1Select = document.getElementById("group1");
            const group2Select = document.getElementById("group2");
            const group3Select = document.getElementById("group3");
            const group4Select = document.getElementById("group4");

            group4Select.innerHTML = "";

            const selectedGroup1Values = Array.from(
                group1Select.selectedOptions
            ).map((option) => option.value);
            const selectedGroup2Values = Array.from(
                group2Select.selectedOptions
            ).map((option) => option.value);
            const selectedGroup3Values = Array.from(
                group3Select.selectedOptions
            ).map((option) => option.value);


            if (
                selectedGroup1Values.length !== 0 &&
                selectedGroup2Values.length !== 0 &&
                selectedGroup3Values.length !== 0
            ) {
                // Customize this logic based on your data
                const subTypes = dataJSON
                    .filter(
                        (element) =>
                            selectedGroup1Values.includes(element["Comisaria"]) &&
                            selectedGroup2Values.includes(element["Agrupacion"]) &&
                            selectedGroup3Values.includes(element["Nueva Clasificacion"])
                    )
                    .map((element) => element["Tipo de Caso"]);

                const uniqueSubTypes = [...new Set(subTypes)];

                uniqueSubTypes.forEach((subType) => {
                    const option = document.createElement("option");
                    option.value = subType;
                    option.text = subType;
                    group4Select.appendChild(option);
                });
            }
            getTipoCaso(); // Llamar a getTipoCaso() después de poblar group3
        }

        function clearMap() {
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }

            // if (markers) {
            //     markers.clearLayers();
            // }
            arrayHeat.length = 0;

            if (circleMarkersLayer) {
                map.removeLayer(circleMarkersLayer);
            }
        }

        function agregarMarcadores(datosPrimeraHoja) {
            clearMarkers();
            let contador = 0;
            datosPrimeraHoja.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const tipoMegafono = marcador.MEGAFONO;

                if (tipoMegafono === "MEGAFONO") {
                    const popupInfo = `Punto: ${marcador.PUNTO}<br>Tipo: ${marcador.TIPO}<br>Descripción: ${marcador.DESCRIPCION}<br>Tipo de Camara: ${marcador["TIPO DE CAMARA"]}<br>Latitud: ${marcador.LATITUD}<br>Longitud: ${marcador.LONGITUD}`;
                    const customIcon = L.icon({
                        iconUrl:
                            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const marker = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers.push(marker);
                    marker.bindPopup(popupInfo);

                    contador++;
                }
            });
            actualizarContador(1, contador);
        }


        async function obtenerDatos() {
            const url =
                "https://script.google.com/macros/s/AKfycbwWeVYAR5A5l_b0VE_URB0dXnxyGGQMSiFviisenNdTOETaqxdizzYsMXJVzlqO4cPi/exec"; // Reemplaza con la URL de tu Google Sheets
            // "https://script.google.com/macros/s/AKfycbyWlzf8DwZdLRx1u9KW8hBXL1TW5B9QQzNcI85hqagmDGu3cfB7VRRSy0ALwNzG7Hgw/exec"; // Reemplaza con la URL de tu Google Sheets
            try {
                const respuesta = await fetch(url);
                const datos = await respuesta.json();
                document.getElementById("mostrarMarcadoresCheckbox10").checked &&
                    agregarMarcadores10(datos.PrimeraHoja);
                // document.getElementById("mostrarMarcadoresCheckbox2").checked &&
                //   agregarMarcadores2(datos.PrimeraHoja);
                // document.getElementById("mostrarMarcadoresCheckbox3").checked &&
                //   agregarMarcadores3(datos.PrimeraHoja);
                // document.getElementById("mostrarMarcadoresCheckbox4").checked &&
                //   agregarMarcadores4(datos.PrimeraHoja);
                // document.getElementById("mostrarMarcadoresCheckbox5").checked &&
                //   agregarMarcadores5(datos.PrimeraHoja);
                document.getElementById("mostrarMarcadoresCheckbox6").checked &&
                    agregarMarcadores6(datos.SegundaHoja);
                document.getElementById("mostrarMarcadoresCheckbox7").checked &&
                    agregarMarcadores7(datos.TerceraHoja);
                document.getElementById("mostrarMarcadoresCheckbox8").checked &&
                    agregarMarcadores8(datos.CuartaHoja);
                document.getElementById("mostrarMarcadoresCheckbox9").checked &&
                    agregarMarcadores9(datos.QuintaHoja);
                document.getElementById("mostrarMarcadoresCheckbox11").checked &&
                    agregarMarcadores11(datos.SextaHoja);
                document.getElementById("mostrarMarcadoresCheckbox12").checked &&
                    agregarMarcadores12(datos.SeptimaHoja);
                //console.log(datos.QuintaHoja);
            } catch (error) {
                console.error("Error al obtener los datos:", error);
            }
        }

        function actualizarContador(tipo, cantidad) {
            const idContador = `contadorMarcadores${tipo}`;
            const elementoContador = document.getElementById(idContador);
            if (elementoContador) {
                elementoContador.textContent = `${cantidad}`;
            }
        }

        var currentMarkers = [];
        function clearMarkers() {
            for (var i = 0; i < currentMarkers.length; i++) {
                map.removeLayer(currentMarkers[i]);
            }
            currentMarkers = [];
        }
        var currentMarkers1 = [];
        function clearMarkers1() {
            for (var i = 0; i < currentMarkers1.length; i++) {
                map.removeLayer(currentMarkers1[i]);
            }
            currentMarkers1 = [];
        }
        var currentMarkers2 = [];
        function clearMarkers2() {
            for (var i = 0; i < currentMarkers2.length; i++) {
                map.removeLayer(currentMarkers2[i]);
            }
            currentMarkers2 = [];
        }
        var currentMarkers3 = [];
        function clearMarkers3() {
            for (var i = 0; i < currentMarkers3.length; i++) {
                map.removeLayer(currentMarkers3[i]);
            }
            currentMarkers3 = [];
        }
        var currentMarkers4 = [];
        function clearMarkers4() {
            for (var i = 0; i < currentMarkers4.length; i++) {
                map.removeLayer(currentMarkers4[i]);
            }
            currentMarkers4 = [];
        }
        var currentMarkers5 = [];
        function clearMarkers5() {
            for (var i = 0; i < currentMarkers5.length; i++) {
                map.removeLayer(currentMarkers5[i]);
            }
            currentMarkers5 = [];
        }

        var currentMarkers6 = [];
        function clearMarkers6() {
            for (var i = 0; i < currentMarkers6.length; i++) {
                map.removeLayer(currentMarkers6[i]);
            }
            currentMarkers6 = [];
        }

        var currentMarkers7 = [];
        function clearMarkers7() {
            for (var i = 0; i < currentMarkers7.length; i++) {
                map.removeLayer(currentMarkers7[i]);
            }
            currentMarkers7 = [];
        }

        var currentMarkers8 = [];
        function clearMarkers8() {
            for (var i = 0; i < currentMarkers8.length; i++) {
                map.removeLayer(currentMarkers8[i]);
            }
            currentMarkers8 = [];
        }

        var currentMarkers9 = [];
        function clearMarkers9() {
            for (var i = 0; i < currentMarkers9.length; i++) {
                map.removeLayer(currentMarkers9[i]);
            }
            currentMarkers9 = [];
        }

        var currentMarkers10 = [];
        function clearMarkers10() {
            for (var i = 0; i < currentMarkers10.length; i++) {
                map.removeLayer(currentMarkers10[i]);
            }
            currentMarkers10 = [];
        }

        var currentMarkers11 = [];
        function clearMarkers11() {
            for (var i = 0; i < currentMarkers11.length; i++) {
                map.removeLayer(currentMarkers11[i]);
            }
            currentMarkers11 = [];
        }


        function agregarMarcadores2(data1) {
            clearMarkers1();
            let contador = 0;
            data1.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const tipoMegafono = marcador["BOTON DE PANICO"];

                if (tipoMegafono === "BOTON DE PANICO") {
                    const popupInfo = `Punto: ${marcador.PUNTO}<br>Tipo: ${marcador.TIPO}<br>Descripción: ${marcador.DESCRIPCION}<br>Tipo de Camara: ${marcador["TIPO DE CAMARA"]}<br>Latitud: ${marcador.LATITUD}<br>Longitud: ${marcador.LONGITUD}`;

                    const customIcon = new L.Icon({
                        iconUrl:
                            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png", // Ruta a tu imagen de icono
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const markerptz = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers1.push(markerptz);
                    markerptz.bindPopup(popupInfo);
                    contador++;
                }
            });
            actualizarContador(2, contador);
        }
        function agregarMarcadores3(data1) {
            clearMarkers2();
            let contador = 0;
            data1.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const tipoMegafono = marcador.MEGAFONO;
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                if (tipoMegafono !== "MEGAFONO") {
                    const popupInfo = `Punto: ${marcador.PUNTO}<br>Tipo: ${marcador.TIPO}<br>Descripción: ${marcador.DESCRIPCION}<br>Tipo de Camara: ${marcador["TIPO DE CAMARA"]}<br>Latitud: ${marcador.LATITUD}<br>Longitud: ${marcador.LONGITUD}`;
                    const customIcon = new L.Icon({
                        iconUrl:
                            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png", // Ruta a tu imagen de icono
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const TIPO = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers2.push(TIPO);
                    TIPO.bindPopup(popupInfo);
                    contador++;
                }
            });
            actualizarContador(3, contador);
        }
        function agregarMarcadores4(data1) {
            clearMarkers3();
            let contador = 0;
            data1.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const tipoprioridad = marcador["PRIORIDAD ENERGIA VECINAL AVANCE"];
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                if (
                    tipoprioridad === "TECNOLOGIA GSC" ||
                    tipoprioridad === "PRIORIZADO" ||
                    tipoprioridad === "OK"
                ) {
                    const popupInfo = `Punto: ${marcador.PUNTO}<br>Tipo: ${marcador.TIPO}<br>Descripción: ${marcador.DESCRIPCION}<br>Tipo de Camara: ${marcador["TIPO DE CAMARA"]}<br>Latitud: ${marcador.LATITUD}<br>Longitud: ${marcador.LONGITUD}`;
                    const customIcon = new L.Icon({
                        iconUrl:
                            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png", // Ruta a tu imagen de icono
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const prioridad = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers3.push(prioridad);
                    prioridad.bindPopup(popupInfo);
                    contador++;
                }
            });
            actualizarContador(4, contador);
        }
        function agregarMarcadores5(data1) {
            clearMarkers4();
            let contador = 0;
            data1.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const tipoprioridad = marcador["PLANTADO DE POSTES"];
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                if (tipoprioridad === "PLANTADO") {
                    const popupInfo = `Punto: ${marcador.PUNTO}<br>Tipo: ${marcador.TIPO}<br>Descripción: ${marcador.DESCRIPCION}<br>Tipo de Camara: ${marcador["TIPO DE CAMARA"]}<br>Latitud: ${marcador.LATITUD}<br>Longitud: ${marcador.LONGITUD}`;
                    const customIcon = new L.Icon({
                        iconUrl:
                            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png", // Ruta a tu imagen de icono
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const prioridad = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers4.push(prioridad);
                    prioridad.bindPopup(popupInfo);
                    contador++;
                }
            });
            actualizarContador(5, contador);
        }

        function agregarMarcadores6(datosSegundaHoja) {
            clearMarkers5();
            let contador = 0;
            let sumaConteo = 0;
            datosSegundaHoja.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const actividad = marcador.ACTIVIDAD;
                const cantidad = marcador.CONTEO;
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                if (actividad === "OK") {
                    const popupInfo = `<br>Descripción: ${marcador.nombre_vecino}<br>Latitud: ${marcador.LATITUD}<br>Longitud: ${marcador.LONGITUD}`;
                    const customIcon = new L.Icon({
                        iconUrl:
                            "./camara_vecinal.png", // Ruta a tu imagen de icono
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const prioridad = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers5.push(prioridad);
                    prioridad.bindPopup(popupInfo);
                    contador++;
                    sumaConteo += cantidad;
                }
            });
            actualizarContador(6, sumaConteo);
            // console.log("Suma total de CONTEO:", sumaConteo); 
            // console.log("Contador:", contador); 
        }

        function agregarMarcadores7(datosTerceraHoja) {
            clearMarkers6();
            let contador = 0;
            datosTerceraHoja.forEach((marcador) => {
                const latitud = marcador.Latitud;
                const longitud = marcador.Longitud;
                const id = marcador.ID;
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                if (id === marcador.ID) {
                    const popupInfo = `<br>ID: ${marcador.ID}<br>Latitud: ${marcador.Latitud}<br>Longitud: ${marcador.Longitud}`;
                    const customIcon = new L.Icon({
                        iconUrl:
                            "./basura.png", // Ruta a tu imagen de icono
                        shadowUrl:
                            "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41],
                    });

                    const prioridad = L.marker([latitud, longitud], {
                        icon: customIcon,
                    }).addTo(map);
                    currentMarkers6.push(prioridad);
                    prioridad.bindPopup(popupInfo);
                    contador++;
                }
            });
            actualizarContador(7, contador);
        }

        function agregarMarcadores8(datosCuartaHoja) {
            clearMarkers7();
            let contador = 0;
            datosCuartaHoja.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const interseccion = marcador.INTERSECCIONES;
                const nrocamaras = marcador.CAMARAS;
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                const popupInfo = `<br>INTERSECCIONES: ${interseccion}<br>NRO DE CAMARAS: ${nrocamaras}<br>Latitud: ${latitud}<br>Longitud: ${longitud}`;
                const customIcon = new L.Icon({
                    iconUrl:
                        "./mototaxi.png", // Ruta a tu imagen de icono
                    shadowUrl:
                        "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41],
                });

                const prioridad = L.marker([latitud, longitud], {
                    icon: customIcon,
                }).addTo(map);
                currentMarkers7.push(prioridad);
                prioridad.bindPopup(popupInfo);
                contador++;
            });
            actualizarContador(8, contador);
        }

        function agregarMarcadores9(datosQuintaHoja) {
            clearMarkers8();
            let contador = 0;
            datosQuintaHoja.forEach((marcador) => {
                const latitud = marcador.Latitud;
                const longitud = marcador.Longitud;
                const empresas = marcador.Empresa;
                const referencia = marcador.Referencia;
                const anuncio = marcador.Anuncio;
                const celular = marcador.Celular;
                // const tipoBotonPanico = marcador['BOTON DE PANICO'];

                const popupInfo = `<br>Empresa: ${empresas}<br>Referencia: ${referencia}<br>Anuncio: ${anuncio}<br>Celular: ${celular}<br>Latitud: ${latitud}<br>Longitud: ${longitud}`;
                const customIcon = new L.Icon({
                    iconUrl:
                        "./paneles.png", // Ruta a tu imagen de icono
                    shadowUrl:
                        "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41],
                });

                const prioridad = L.marker([latitud, longitud], {
                    icon: customIcon,
                }).addTo(map);
                currentMarkers8.push(prioridad);
                prioridad.bindPopup(popupInfo);
                contador++;
            });
            actualizarContador(9, contador);
        }

        function agregarMarcadores10(datosPrimeraHoja) {
            clearMarkers9();
            let contador = 0;
            datosPrimeraHoja.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const punto = marcador.PUNTO;
                const tipo = marcador['TIPO DE CAMARA'];

                // Validación del tipo de cámara
                let multiplicador = 1;

                if (tipo.includes('*LPR')) {
                    const multiplicadorStr = tipo.split('*')[0];
                    multiplicador = parseInt(multiplicadorStr, 10) || 1;
                }

                const popupInfo = `<br>Punto: ${punto}<br>Tipo: ${tipo}<br>Latitud: ${latitud}<br>Longitud: ${longitud}`;
                const customIcon = new L.Icon({
                    iconUrl:
                        "./camaras_sjl.png", // Ruta a tu imagen de icono
                    shadowUrl:
                        "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41],
                });

                const prioridad = L.marker([latitud, longitud], {
                    icon: customIcon,
                }).addTo(map);
                currentMarkers9.push(prioridad);
                prioridad.bindPopup(popupInfo);
                ///contador++;
                contador += multiplicador;
            });
            actualizarContador(10, contador);
        }

        function agregarMarcadores11(datosSextaHoja) {
            clearMarkers10();
            let contador = 0;
            datosSextaHoja.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const zona = marcador.ZONA;
                const nombre = marcador.NOMBRE;
                const ubicación = marcador.UBICACIÓN;
                const nro = marcador['N°'];

                const popupInfo = `<br>N°: ${nro}<br>Nombre: ${nombre}<br>Ubicacion: ${ubicación}<br>Zona: ${zona}<br>Latitud: ${latitud}<br>Longitud: ${longitud}`;
                const customIcon = new L.Icon({
                    iconUrl:
                        "./camara_35s.png", // Ruta a tu imagen de icono
                    shadowUrl:
                        "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41],
                });

                const prioridad = L.marker([latitud, longitud], {
                    icon: customIcon,
                }).addTo(map);
                currentMarkers10.push(prioridad);
                prioridad.bindPopup(popupInfo);
                contador++;
                //contador += multiplicador;
            });
            actualizarContador(11, contador);
        }

        function agregarMarcadores12(datosSeptimaHoja) {
            clearMarkers11();
            let contador = 0;
            datosSeptimaHoja.forEach((marcador) => {
                const latitud = marcador.LATITUD;
                const longitud = marcador.LONGITUD;
                const modelo = marcador.MODELO;
                const jurisdiccion = marcador.JURIDICCIÓN;
                const nombre_vecino = marcador['NOMBRE VECINO'];

                const popupInfo = `<br>Modelo: ${modelo}<br>Jurisdiccion: ${jurisdiccion}<br>Nombre Vecino: ${nombre_vecino}`;
                const customIcon = new L.Icon({
                    iconUrl:
                        "./camara_caja_de_agua.png", // Ruta a tu imagen de icono
                    shadowUrl:
                        "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41],
                });

                const prioridad = L.marker([latitud, longitud], {
                    icon: customIcon,
                }).addTo(map);
                currentMarkers11.push(prioridad);
                prioridad.bindPopup(popupInfo);
                contador++;
                //contador += multiplicador;
            });
            actualizarContador(12, contador);
        }


        document
            .getElementById("mostrarMarcadoresCheckbox6")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers5();
                }
            });

        document
            .getElementById("mostrarMarcadoresCheckbox7")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers6();
                }
            });

        document
            .getElementById("mostrarMarcadoresCheckbox8")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers7();
                }
            });

        document
            .getElementById("mostrarMarcadoresCheckbox9")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers8();
                }
            });

        document
            .getElementById("mostrarMarcadoresCheckbox10")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers9();
                }
            });

        document
            .getElementById("mostrarMarcadoresCheckbox11")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers10();
                }
            });

        document
            .getElementById("mostrarMarcadoresCheckbox12")
            .addEventListener("change", (event) => {
                if (event.target.checked) {
                    obtenerDatos();
                } else {
                    clearMarkers11();
                }
            });

        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                dataJSON = data;

                // Llenar group1Select con opciones
                const group1Select = document.getElementById("group1");
                const arrayGroup1 = [];
                dataJSON.forEach((element) => {
                    arrayGroup1.push(element["Comisaria"]);
                });
                const arrayGroup1Unique = [...new Set(arrayGroup1)];
                arrayGroup1Unique.forEach((element) => {
                    const option = document.createElement("option");
                    option.value = element;
                    option.text = element;
                    group1Select.appendChild(option);
                });

                // Inicializar el grupo de marcadores
                markers = L.markerClusterGroup();
                map.addLayer(markers);
            })
            .catch((error) =>
                console.error("Error al cargar el archivo JSON:", error)
            );
            map.addControl(new L.Control.Fullscreen());

// Definir variables para las rutas y marcadores
var rutas = []; 
var puntosRuta = [];

// Objeto para mapear los iconos de marcadores con los colores de ruta
var iconoColorMap = {
    'policia.png': 'red',
    'moto.png': 'blue',
    'sereno.png': 'green'
};

// Objeto para mapear los nombres de los marcadores con su icono
var nombreIconoMap = {
    'policia.png': 'Policía',
    'moto.png': 'Moto',
    'sereno.png': 'Sereno'
};

// Variable para la línea temporal
var rectaTemporal;

// Función para agregar un punto de ruta
function agregarPuntoRuta(coordenadas) {
    if (!marcadorSeleccionado) {
        return; // No hacer nada si no se ha seleccionado un marcador
    }
    var icono = L.icon({ iconUrl: marcadorSeleccionado, iconSize: [30, 30] });
    var marcador = L.marker(coordenadas, { icon: icono }).addTo(map);
    marcador.bindPopup(nombreIconoMap[marcadorSeleccionado]); // Mostrar nombre del marcador en el popup
    puntosRuta.push({ marcador: marcador, tipo: nombreIconoMap[marcadorSeleccionado], lat: coordenadas.lat, lng: coordenadas.lng });
    actualizarRectaTemporal();
}

// Evento para mostrar los botones de selección de marcador al hacer clic derecho
map.on('contextmenu', function(e) {
    mostrarBotonesSeleccionMarcador(e.latlng);
});

// Función para mostrar los botones de selección de marcador
 function mostrarBotonesSeleccionMarcador(coordenadas) {
        var container = L.DomUtil.create('div');
        var botonPolicia = createSelectMarkerButton('policia.png', parseInt(document.getElementById('qty1').textContent));
        var botonMoto = createSelectMarkerButton('moto.png', parseInt(document.getElementById('qty2').textContent));
        var botonSereno = createSelectMarkerButton('sereno.png', parseInt(document.getElementById('qty3').textContent));
        
        container.appendChild(botonPolicia);
        container.appendChild(botonMoto);
        container.appendChild(botonSereno);

        L.popup()
            .setLatLng(coordenadas)
            .setContent(container)
            .openOn(map);
    }


// Función para crear un botón de selección de marcador
// function createSelectMarkerButton(iconoUrl) {
//     var boton = L.DomUtil.create('button', 'select-marker-button');
//     boton.innerHTML =  `<img src="${iconoUrl}" width="30" height="30" />`;
//     boton.onclick = function() {
//         marcadorSeleccionado = iconoUrl;
//         map.closePopup();
//     };
//     return boton;
// }
function createSelectMarkerButton(iconoUrl, cantidadDisponible) {
        var boton = L.DomUtil.create('button', 'select-marker-button');
        boton.innerHTML =  `<img src="${iconoUrl}" width="30" height="30" />`;
        boton.disabled = cantidadDisponible === 0; // Deshabilitar el botón si la cantidad disponible es cero
        boton.onclick = function() {
            if (cantidadDisponible > 0) { // Solo seleccionar si hay cantidad disponible
                marcadorSeleccionado = iconoUrl;
                map.closePopup();
            }
        };
        return boton;
    }
// Función para dibujar la ruta al hacer clic izquierdo
map.on('click', function(e) {
    agregarPuntoRuta(e.latlng);
});

// Evento para crear la ruta al presionar Enter
document.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        crearRuta();
    }
});

// Función para crear la ruta
function crearRuta() {
        if (marcadorSeleccionado) {
            var colorRuta = iconoColorMap[marcadorSeleccionado];
            
            // Verificar si hay marcadores disponibles
            var cardId = getCardIdByMarkerType(nombreIconoMap[marcadorSeleccionado]);
            var quantityElement = document.getElementById(`qty${cardId}`);
            var cantidadDisponible = parseInt(quantityElement.textContent);
            
            if (cantidadDisponible === 0) {
                alert('Ya no hay marcadores disponibles para crear más rutas.');
                return;
            }
            
            var polilinea = L.polyline(puntosRuta.map(p => [p.lat, p.lng]), { color: colorRuta });
            polilinea.addTo(map);
            rutas.push({polilinea: polilinea, marcadores: puntosRuta}); // Agregar la ruta a la lista de rutas con sus marcadores asociados
            
            // Crear un conjunto para llevar un registro de los tipos de marcadores utilizados en la ruta actual
            var tiposUtilizados = new Set();
            puntosRuta.forEach(punto => {
                tiposUtilizados.add(punto.tipo);
            });

            // Disminuir la cantidad de cada tipo de marcador utilizado en la ruta
            tiposUtilizados.forEach(tipo => {
                var cardId = getCardIdByMarkerType(tipo);
                var quantityElement = document.getElementById(`qty${cardId}`);
                quantityElement.textContent = parseInt(quantityElement.textContent) - 1; // Disminuir la cantidad en 1
            });

            puntosRuta = []; // Limpiar puntos de ruta
            marcadorSeleccionado = null; // Restablecer selección de marcador
            actualizarRectaTemporal();
        } else {
            alert('Seleccione un marcador antes de crear la ruta.');
        }
    }

    function getCardIdByMarkerType(markerType) {
        switch (markerType) {
            case 'Policía':
                return 1;
            case 'Moto':
                return 2;
            case 'Sereno':
                return 3;
            default:
                return null;
        }
    }

// Función para actualizar la recta temporal
function actualizarRectaTemporal() {
    if (puntosRuta.length > 1) {
        var lineLatLngs = [puntosRuta[puntosRuta.length - 2], puntosRuta[puntosRuta.length - 1]];
        if (rectaTemporal) {
            map.removeLayer(rectaTemporal);
        }
        rectaTemporal = L.polyline(lineLatLngs.map(p => [p.lat, p.lng]), { color: 'gray', dashArray: '5, 10' }).addTo(map);
    }
}

// Función para exportarlas coordenadas a Excel
document.getElementById('exportarExcel').addEventListener('click', function() {
    exportarExcel();
});

function exportarExcel() {
    var wb = XLSX.utils.book_new();
    var wsData = [['Ruta', 'Tipo de Marcador', 'Latitud', 'Longitud']];
    rutas.forEach((ruta, index) => {
        ruta.marcadores.forEach(punto => {
            wsData.push([index + 1, punto.tipo, punto.lat, punto.lng]);
        });
    });

    var ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'Coordenadas');

    // Crear un Blob para guardar el archivo Excel
    var wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});

    // Convertir el Blob a un objeto URL
    var blob = new Blob([wbout], {type: 'application/octet-stream'});
    var url = window.URL.createObjectURL(blob);

    // Crear un enlace y hacer clic en él para descargar el archivo
    var a = document.createElement('a');
    document.body.appendChild(a);
    a.href = url;
    a.download = 'coordenadas.xlsx';
    a.click();

    // Liberar el objeto URL
    setTimeout(function() {
        window.URL.revokeObjectURL(url);
    }, 0);
}

// Función para eliminar el último polígono creado
document.getElementById('eliminarUltimoPoligono').addEventListener('click', function() {
    eliminarUltimoPoligono();
});

function eliminarUltimoPoligono() {
    if (rutas.length > 0) {
        var ultimoPoligono = rutas.pop(); // Eliminar el último polígono de la lista
        map.removeLayer(ultimoPoligono.polilinea); // Quitar el último polígono del mapa
        ultimoPoligono.marcadores.forEach(punto => {
            map.removeLayer(punto.marcador); // Quitar los marcadores del mapa
        });
    } else {
        alert('No hay polígonos para eliminar.');
    }
}
    </script>
    
    <script src="./assets/vendor/libs/popper/popper.js"></script>
    <script src="./assets/vendor/js/bootstrap.js"></script>
    <script src="./assets/vendor/libs/node-waves/node-waves.js"></script>
    <script src="./assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
    <script src="./assets/vendor/libs/hammer/hammer.js"></script>
    <script src="./assets/vendor/libs/i18n/i18n.js"></script>
    <script src="./assets/vendor/libs/typeahead-js/typeahead.js"></script>
    <script src="./assets/vendor/js/menu.js"></script>
    <script src="./assets/vendor/libs/cleavejs/cleave.js"></script>
    <script src="./assets/vendor/libs/cleavejs/cleave-phone.js"></script>
    <script src="./assets/vendor/libs/select2/select2.js"></script>
    <script src="./assets/vendor/libs/@form-validation/umd/bundle/popular.min.js"></script>
    <script src="./assets/vendor/libs/@form-validation/umd/plugin-bootstrap5/index.min.js"></script>
    <script src="./assets/vendor/libs/@form-validation/umd/plugin-auto-focus/index.min.js"></script>
    <script src="./assets/vendor/libs/bs-stepper/bs-stepper.js"></script>
    <script src="./assets/js/main.js"></script>

    <!-- Page JS -->
    <script src="./assets/js/pages-pricing.js"></script>
    <script src="./assets/js/modal-create-app.js"></script>
    <script src="./assets/js/modal-add-new-cc.js"></script>
    <script src="./assets/js/modal-add-new-address.js"></script>
    <script src="./assets/js/modal-edit-user.js"></script>
    <script src="./assets/js/modal-enable-otp.js"></script>
    <script src="./assets/js/modal-share-project.js"></script>
    <script src="./assets/js/modal-two-factor-auth.js"></script>

</body>

</html>